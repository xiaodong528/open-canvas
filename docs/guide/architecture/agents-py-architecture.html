<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Canvas Python 后端架构</title>
    <style>
        :root {
            --bg-primary: #1e1e1e;
            --bg-secondary: #252526;
            --bg-tertiary: #2d2d30;
            --bg-hover: #3c3c3c;
            --text-primary: #d4d4d4;
            --text-secondary: #9d9d9d;
            --accent-blue: #007acc;
            --accent-green: #4ec9b0;
            --accent-orange: #ce9178;
            --accent-purple: #c586c0;
            --accent-yellow: #dcdcaa;
            --border-color: #3c3c3c;
            --node-artifact: #4fc3f7;
            --node-dialog: #81c784;
            --node-route: #ffb74d;
            --node-aux: #ba68c8;
            --node-control: #e57373;
        }

        /* Light Theme */
        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-tertiary: #e8e8e8;
            --bg-hover: #e0e0e0;
            --text-primary: #1e1e1e;
            --text-secondary: #666666;
            --accent-blue: #0066cc;
            --accent-green: #2e7d32;
            --accent-orange: #c75000;
            --accent-purple: #9c27b0;
            --accent-yellow: #7c6f00;
            --border-color: #d0d0d0;
        }

        [data-theme="light"] .node-text {
            fill: #ffffff !important;
        }

        [data-theme="light"] .edge {
            stroke: #666666;
        }

        [data-theme="light"] .edge-label {
            fill: #666666;
        }

        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            background-color: var(--bg-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 1001;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            border-color: var(--accent-blue);
        }

        .theme-toggle svg {
            width: 24px;
            height: 24px;
            fill: var(--text-primary);
            transition: transform 0.3s ease;
        }

        .theme-toggle:hover svg {
            transform: rotate(15deg);
        }

        .sun-icon, .moon-icon {
            position: absolute;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        [data-theme="light"] .moon-icon {
            opacity: 1;
            transform: rotate(0deg);
        }

        [data-theme="light"] .sun-icon {
            opacity: 0;
            transform: rotate(-90deg);
        }

        [data-theme="dark"] .sun-icon,
        :root:not([data-theme]) .sun-icon {
            opacity: 1;
            transform: rotate(0deg);
        }

        [data-theme="dark"] .moon-icon,
        :root:not([data-theme]) .moon-icon {
            opacity: 0;
            transform: rotate(90deg);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Layout */
        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Navigation */
        .sidebar {
            width: 280px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            padding: 20px 0;
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-header h1 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-header p {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .nav-section {
            padding: 16px 0;
        }

        .nav-section-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0 20px 8px;
        }

        .nav-link {
            display: block;
            padding: 8px 20px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .nav-link:hover {
            background-color: var(--bg-hover);
        }

        .nav-link.active {
            background-color: var(--bg-tertiary);
            border-left: 2px solid var(--accent-blue);
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 40px;
            max-width: 1200px;
        }

        section {
            margin-bottom: 60px;
        }

        h2 {
            font-size: 28px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        h3 {
            font-size: 20px;
            font-weight: 600;
            color: var(--accent-blue);
            margin: 24px 0 16px;
        }

        h4 {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent-green);
            margin: 16px 0 12px;
        }

        p {
            margin-bottom: 16px;
            color: var(--text-secondary);
        }

        /* Cards */
        .card {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
            cursor: pointer;
        }

        .card-header h3 {
            margin: 0;
            flex: 1;
        }

        .collapse-icon {
            font-size: 18px;
            color: var(--text-secondary);
            transition: transform 0.3s;
        }

        .card.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .card.collapsed .card-content {
            display: none;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 16px 0;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--bg-tertiary);
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            color: var(--text-secondary);
        }

        td code {
            background-color: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            color: var(--accent-orange);
        }

        /* Code Blocks */
        pre {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            margin: 16px 0;
        }

        code {
            font-family: 'Consolas', 'Monaco', 'Fira Code', monospace;
            font-size: 13px;
            line-height: 1.5;
        }

        .keyword { color: var(--accent-purple); }
        .string { color: var(--accent-orange); }
        .function { color: var(--accent-yellow); }
        .type { color: var(--accent-green); }
        .comment { color: #6a9955; }
        .number { color: #b5cea8; }

        /* Flow Diagram Container */
        .diagram-container {
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            margin: 24px 0;
            overflow-x: auto;
        }

        .diagram-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 16px;
            text-align: center;
        }

        /* SVG Styles */
        svg {
            display: block;
            margin: 0 auto;
        }

        .node {
            cursor: pointer;
            transition: filter 0.2s;
        }

        .node:hover {
            filter: brightness(1.2);
        }

        .node-rect {
            rx: 6;
            ry: 6;
        }

        .node-text {
            font-family: 'Consolas', monospace;
            font-size: 12px;
            fill: var(--bg-primary);
            text-anchor: middle;
            dominant-baseline: middle;
            pointer-events: none;
        }

        .edge {
            fill: none;
            stroke: var(--text-secondary);
            stroke-width: 2;
            marker-end: url(#arrowhead);
        }

        .edge-label {
            font-size: 10px;
            fill: var(--text-secondary);
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background-color: var(--bg-secondary);
            border: 1px solid var(--accent-blue);
            border-radius: 6px;
            padding: 12px 16px;
            max-width: 300px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-title {
            font-weight: 600;
            color: var(--accent-blue);
            margin-bottom: 8px;
        }

        .tooltip-content {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin: 16px 0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* State Field */
        .state-field {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            background-color: var(--bg-tertiary);
            border-radius: 6px;
            margin: 8px 0;
        }

        .state-field-name {
            font-family: monospace;
            color: var(--accent-blue);
            min-width: 180px;
        }

        .state-field-type {
            font-family: monospace;
            color: var(--accent-green);
            min-width: 200px;
        }

        .state-field-desc {
            color: var(--text-secondary);
            font-size: 13px;
        }

        /* Route Priority */
        .route-priority {
            counter-reset: priority;
        }

        .route-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background-color: var(--bg-tertiary);
            border-radius: 6px;
            margin: 8px 0;
        }

        .route-item::before {
            counter-increment: priority;
            content: counter(priority);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background-color: var(--accent-blue);
            color: var(--bg-primary);
            border-radius: 50%;
            font-weight: 600;
            margin-right: 16px;
            flex-shrink: 0;
        }

        .route-condition {
            font-family: monospace;
            color: var(--accent-orange);
            min-width: 300px;
        }

        .route-arrow {
            color: var(--text-secondary);
            margin: 0 16px;
        }

        .route-target {
            font-family: monospace;
            color: var(--accent-green);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }
            .main-content {
                margin-left: 240px;
                padding: 24px;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <button class="theme-toggle" id="themeToggle" aria-label="切换主题">
        <svg class="sun-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="5" fill="none" stroke="currentColor" stroke-width="2"/>
            <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <svg class="moon-icon" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>

    <div class="container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1>Open Canvas</h1>
                <p>Python 后端架构文档</p>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">概览</div>
                <a href="#overview" class="nav-link active">系统架构</a>
                <a href="#graphs-overview" class="nav-link">图总览</a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">主图</div>
                <a href="#main-graph" class="nav-link">open-canvas 图</a>
                <a href="#routing" class="nav-link">路由逻辑</a>
                <a href="#nodes" class="nav-link">节点详情</a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">状态</div>
                <a href="#state" class="nav-link">状态结构</a>
                <a href="#types" class="nav-link">类型定义</a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">辅助图</div>
                <a href="#reflection" class="nav-link">reflection</a>
                <a href="#thread-title" class="nav-link">thread_title</a>
                <a href="#summarizer" class="nav-link">summarizer</a>
                <a href="#web-search" class="nav-link">web_search</a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">数据流</div>
                <a href="#data-flow" class="nav-link">请求处理流程</a>
                <a href="#files" class="nav-link">文件映射</a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Section -->
            <section id="overview">
                <h2>系统架构概览</h2>
                <p>Open Canvas Python 后端基于 LangGraph 构建，包含 5 个独立的状态图，协同处理用户的对话和工件操作请求。</p>

                <div class="diagram-container">
                    <div class="diagram-title">系统架构图</div>
                    <svg width="900" height="400" viewBox="0 0 900 400">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#9d9d9d"/>
                            </marker>
                        </defs>

                        <!-- Frontend -->
                        <rect x="50" y="30" width="160" height="60" rx="8" fill="#3c3c3c" stroke="#007acc" stroke-width="2"/>
                        <text x="130" y="65" class="node-text" fill="#d4d4d4" font-size="14">Next.js 前端</text>

                        <!-- LangGraph Server -->
                        <rect x="50" y="130" width="800" height="240" rx="8" fill="#252526" stroke="#3c3c3c" stroke-width="2"/>
                        <text x="450" y="155" class="node-text" fill="#9d9d9d" font-size="12">LangGraph Server (Port 54367)</text>

                        <!-- Main Graph -->
                        <rect x="80" y="180" width="280" height="160" rx="6" fill="#2d2d30" stroke="#ffb74d" stroke-width="2"/>
                        <text x="220" y="205" class="node-text" fill="#ffb74d" font-size="13" font-weight="bold">open-canvas (主图)</text>
                        <text x="220" y="230" class="node-text" fill="#9d9d9d" font-size="11">17 个节点</text>
                        <text x="220" y="250" class="node-text" fill="#9d9d9d" font-size="11">路由决策 + 工件管理</text>
                        <text x="220" y="270" class="node-text" fill="#9d9d9d" font-size="11">对话处理 + 反思更新</text>

                        <!-- Auxiliary Graphs -->
                        <rect x="400" y="180" width="140" height="70" rx="6" fill="#2d2d30" stroke="#ba68c8" stroke-width="2"/>
                        <text x="470" y="210" class="node-text" fill="#ba68c8" font-size="12">reflection</text>
                        <text x="470" y="230" class="node-text" fill="#9d9d9d" font-size="10">记忆存储</text>

                        <rect x="560" y="180" width="140" height="70" rx="6" fill="#2d2d30" stroke="#ba68c8" stroke-width="2"/>
                        <text x="630" y="210" class="node-text" fill="#ba68c8" font-size="12">thread_title</text>
                        <text x="630" y="230" class="node-text" fill="#9d9d9d" font-size="10">标题生成</text>

                        <rect x="720" y="180" width="100" height="70" rx="6" fill="#2d2d30" stroke="#ba68c8" stroke-width="2"/>
                        <text x="770" y="210" class="node-text" fill="#ba68c8" font-size="12">summarizer</text>
                        <text x="770" y="230" class="node-text" fill="#9d9d9d" font-size="10">对话压缩</text>

                        <rect x="400" y="270" width="140" height="70" rx="6" fill="#2d2d30" stroke="#81c784" stroke-width="2"/>
                        <text x="470" y="300" class="node-text" fill="#81c784" font-size="12">web_search</text>
                        <text x="470" y="320" class="node-text" fill="#9d9d9d" font-size="10">Exa 搜索 (3 节点)</text>

                        <!-- Store -->
                        <rect x="600" y="270" width="220" height="70" rx="6" fill="#2d2d30" stroke="#4fc3f7" stroke-width="2"/>
                        <text x="710" y="300" class="node-text" fill="#4fc3f7" font-size="12">BaseStore</text>
                        <text x="710" y="320" class="node-text" fill="#9d9d9d" font-size="10">跨线程记忆存储</text>

                        <!-- Arrows -->
                        <path d="M 130 90 L 130 130" class="edge"/>
                        <text x="140" y="115" class="edge-label">SSE Stream</text>
                    </svg>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffb74d;"></div>
                        <span>主图 (路由/工件)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ba68c8;"></div>
                        <span>辅助图 (单节点)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #81c784;"></div>
                        <span>搜索图 (多节点)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4fc3f7;"></div>
                        <span>存储层</span>
                    </div>
                </div>
            </section>

            <!-- Graphs Overview -->
            <section id="graphs-overview">
                <h2>图总览</h2>
                <p>所有图在 <code>langgraph.json</code> 中配置：</p>

                <table>
                    <thead>
                        <tr>
                            <th>图名</th>
                            <th>入口点</th>
                            <th>节点数</th>
                            <th>用途</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>agent</code></td>
                            <td><code>src.open_canvas.graph:graph</code></td>
                            <td>17</td>
                            <td>主代理 - 路由决策、工件管理、对话处理</td>
                        </tr>
                        <tr>
                            <td><code>reflection</code></td>
                            <td><code>src.reflection.graph:graph</code></td>
                            <td>1</td>
                            <td>生成用户洞察/风格规则，存储到 Store</td>
                        </tr>
                        <tr>
                            <td><code>thread_title</code></td>
                            <td><code>src.thread_title.graph:graph</code></td>
                            <td>1</td>
                            <td>自动生成对话标题，更新线程元数据</td>
                        </tr>
                        <tr>
                            <td><code>summarizer</code></td>
                            <td><code>src.summarizer.graph:graph</code></td>
                            <td>1</td>
                            <td>压缩长对话历史，防止上下文爆炸</td>
                        </tr>
                        <tr>
                            <td><code>web_search</code></td>
                            <td><code>src.web_search.graph:graph</code></td>
                            <td>3</td>
                            <td>基于 Exa 的网络搜索集成</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Main Graph -->
            <section id="main-graph">
                <h2>主图: open-canvas</h2>
                <p>主图是 Open Canvas 的核心，处理所有用户请求的路由和分发。</p>

                <div class="diagram-container">
                    <div class="diagram-title">open-canvas 图结构 (17 个节点)</div>
                    <svg width="1000" height="700" viewBox="0 0 1000 700">
                        <defs>
                            <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                                <polygon points="0 0, 10 3.5, 0 7" fill="#9d9d9d"/>
                            </marker>
                        </defs>

                        <!-- START -->
                        <circle cx="500" cy="40" r="20" fill="#81c784"/>
                        <text x="500" y="45" class="node-text" font-size="11">START</text>

                        <!-- generatePath -->
                        <g class="node" data-node="generatePath">
                            <rect x="420" y="90" width="160" height="45" class="node-rect" fill="#ffb74d"/>
                            <text x="500" y="117" class="node-text">generatePath</text>
                        </g>

                        <!-- Branch nodes - Artifact Operations -->
                        <g class="node" data-node="generateArtifact">
                            <rect x="50" y="200" width="150" height="40" class="node-rect" fill="#4fc3f7"/>
                            <text x="125" y="225" class="node-text">generateArtifact</text>
                        </g>

                        <g class="node" data-node="rewriteArtifact">
                            <rect x="50" y="260" width="150" height="40" class="node-rect" fill="#4fc3f7"/>
                            <text x="125" y="285" class="node-text">rewriteArtifact</text>
                        </g>

                        <g class="node" data-node="updateArtifact">
                            <rect x="50" y="320" width="150" height="40" class="node-rect" fill="#4fc3f7"/>
                            <text x="125" y="345" class="node-text">updateArtifact</text>
                        </g>

                        <g class="node" data-node="updateHighlightedText">
                            <rect x="50" y="380" width="170" height="40" class="node-rect" fill="#4fc3f7"/>
                            <text x="135" y="405" class="node-text">updateHighlightedText</text>
                        </g>

                        <g class="node" data-node="rewriteArtifactTheme">
                            <rect x="250" y="200" width="170" height="40" class="node-rect" fill="#4fc3f7"/>
                            <text x="335" y="225" class="node-text">rewriteArtifactTheme</text>
                        </g>

                        <g class="node" data-node="rewriteCodeArtifactTheme">
                            <rect x="240" y="260" width="190" height="40" class="node-rect" fill="#4fc3f7"/>
                            <text x="335" y="285" class="node-text">rewriteCodeArtifactTheme</text>
                        </g>

                        <g class="node" data-node="customAction">
                            <rect x="250" y="320" width="140" height="40" class="node-rect" fill="#4fc3f7"/>
                            <text x="320" y="345" class="node-text">customAction</text>
                        </g>

                        <!-- Dialog node -->
                        <g class="node" data-node="replyToGeneralInput">
                            <rect x="590" y="200" width="170" height="40" class="node-rect" fill="#81c784"/>
                            <text x="675" y="225" class="node-text">replyToGeneralInput</text>
                        </g>

                        <!-- Web Search -->
                        <g class="node" data-node="webSearch">
                            <rect x="800" y="200" width="130" height="40" class="node-rect" fill="#ba68c8"/>
                            <text x="865" y="225" class="node-text">webSearch</text>
                        </g>

                        <g class="node" data-node="routePostWebSearch">
                            <rect x="790" y="280" width="150" height="40" class="node-rect" fill="#ba68c8"/>
                            <text x="865" y="305" class="node-text">routePostWebSearch</text>
                        </g>

                        <!-- generateFollowup -->
                        <g class="node" data-node="generateFollowup">
                            <rect x="250" y="480" width="160" height="40" class="node-rect" fill="#81c784"/>
                            <text x="330" y="505" class="node-text">generateFollowup</text>
                        </g>

                        <!-- reflect -->
                        <g class="node" data-node="reflect">
                            <rect x="460" y="480" width="100" height="40" class="node-rect" fill="#81c784"/>
                            <text x="510" y="505" class="node-text">reflect</text>
                        </g>

                        <!-- cleanState -->
                        <g class="node" data-node="cleanState">
                            <rect x="420" y="560" width="130" height="40" class="node-rect" fill="#e57373"/>
                            <text x="485" y="585" class="node-text">cleanState</text>
                        </g>

                        <!-- generateTitle -->
                        <g class="node" data-node="generateTitle">
                            <rect x="280" y="640" width="140" height="40" class="node-rect" fill="#81c784"/>
                            <text x="350" y="665" class="node-text">generateTitle</text>
                        </g>

                        <!-- summarizer -->
                        <g class="node" data-node="summarizer">
                            <rect x="460" y="640" width="120" height="40" class="node-rect" fill="#ba68c8"/>
                            <text x="520" y="665" class="node-text">summarizer</text>
                        </g>

                        <!-- END -->
                        <circle cx="700" cy="660" r="20" fill="#e57373"/>
                        <text x="700" y="665" class="node-text" font-size="11">END</text>

                        <!-- Edges -->
                        <!-- START -> generatePath -->
                        <path d="M 500 60 L 500 90" class="edge" marker-end="url(#arrow)"/>

                        <!-- generatePath -> branches (conditional) -->
                        <path d="M 420 112 L 200 112 L 200 200" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 420 112 L 335 112 L 335 200" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 580 112 L 675 112 L 675 200" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 580 112 L 865 112 L 865 200" class="edge" marker-end="url(#arrow)"/>

                        <!-- Artifact nodes -> generateFollowup -->
                        <path d="M 125 240 L 125 460 L 250 500" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 125 300 L 125 460 L 250 500" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 125 360 L 125 460 L 250 500" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 135 420 L 135 460 L 250 500" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 335 240 L 330 460 L 330 480" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 335 300 L 330 460 L 330 480" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 320 360 L 320 480" class="edge" marker-end="url(#arrow)"/>

                        <!-- webSearch -> routePostWebSearch -->
                        <path d="M 865 240 L 865 280" class="edge" marker-end="url(#arrow)"/>

                        <!-- routePostWebSearch -> artifact nodes -->
                        <path d="M 790 300 L 200 300 L 200 260" class="edge" marker-end="url(#arrow)" stroke-dasharray="5,5"/>
                        <path d="M 790 300 L 200 300 L 200 220" class="edge" marker-end="url(#arrow)" stroke-dasharray="5,5"/>

                        <!-- replyToGeneralInput -> cleanState -->
                        <path d="M 675 240 L 675 560 L 550 580" class="edge" marker-end="url(#arrow)"/>

                        <!-- generateFollowup -> reflect -->
                        <path d="M 410 500 L 460 500" class="edge" marker-end="url(#arrow)"/>

                        <!-- reflect -> cleanState -->
                        <path d="M 510 520 L 485 560" class="edge" marker-end="url(#arrow)"/>

                        <!-- cleanState -> conditional -->
                        <path d="M 420 580 L 350 580 L 350 640" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 485 600 L 520 640" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 550 580 L 700 580 L 700 640" class="edge" marker-end="url(#arrow)"/>

                        <!-- generateTitle -> END -->
                        <path d="M 420 660 L 460 660" class="edge" marker-end="url(#arrow)"/>

                        <!-- summarizer -> END -->
                        <path d="M 580 660 L 680 660" class="edge" marker-end="url(#arrow)"/>

                        <!-- Labels -->
                        <text x="300" y="100" class="edge-label" fill="#9d9d9d">条件路由 (route_node)</text>
                        <text x="350" y="620" class="edge-label" fill="#9d9d9d">messages &lt;= 2</text>
                        <text x="520" y="620" class="edge-label" fill="#9d9d9d">chars &gt; 300K</text>
                        <text x="620" y="620" class="edge-label" fill="#9d9d9d">否则</text>
                    </svg>
                </div>

                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ffb74d;"></div>
                        <span>路由节点</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #4fc3f7;"></div>
                        <span>工件操作节点</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #81c784;"></div>
                        <span>对话节点</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #ba68c8;"></div>
                        <span>辅助节点</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: #e57373;"></div>
                        <span>控制节点</span>
                    </div>
                </div>
            </section>

            <!-- Routing Logic -->
            <section id="routing">
                <h2>路由逻辑</h2>
                <p><code>generatePath</code> 节点根据状态字段决定下一个处理节点。路由采用 <strong>硬编码优先 + LLM 动态</strong> 的策略。</p>

                <h3>路由优先级</h3>
                <div class="route-priority">
                    <div class="route-item">
                        <span class="route-condition">highlightedCode 存在</span>
                        <span class="route-arrow">→</span>
                        <span class="route-target">updateArtifact</span>
                    </div>
                    <div class="route-item">
                        <span class="route-condition">highlightedText 存在</span>
                        <span class="route-arrow">→</span>
                        <span class="route-target">updateHighlightedText</span>
                    </div>
                    <div class="route-item">
                        <span class="route-condition">language | artifactLength | readingLevel | regenerateWithEmojis</span>
                        <span class="route-arrow">→</span>
                        <span class="route-target">rewriteArtifactTheme</span>
                    </div>
                    <div class="route-item">
                        <span class="route-condition">addComments | addLogs | portLanguage | fixBugs</span>
                        <span class="route-arrow">→</span>
                        <span class="route-target">rewriteCodeArtifactTheme</span>
                    </div>
                    <div class="route-item">
                        <span class="route-condition">customQuickActionId 存在</span>
                        <span class="route-arrow">→</span>
                        <span class="route-target">customAction</span>
                    </div>
                    <div class="route-item">
                        <span class="route-condition">webSearchEnabled = true</span>
                        <span class="route-arrow">→</span>
                        <span class="route-target">webSearch</span>
                    </div>
                    <div class="route-item">
                        <span class="route-condition">(默认) LLM 动态路由</span>
                        <span class="route-arrow">→</span>
                        <span class="route-target">replyToGeneralInput | generateArtifact | rewriteArtifact</span>
                    </div>
                </div>

                <h3>LLM 动态路由</h3>
                <p>当没有硬编码条件匹配时，使用 LLM 分析用户意图：</p>
                <pre><code><span class="keyword">async def</span> <span class="function">_dynamic_determine_path</span>(state, config) -> <span class="type">str</span>:
    <span class="comment"># 无工件 → generateArtifact</span>
    <span class="keyword">if not</span> current_artifact_content:
        <span class="keyword">return</span> <span class="string">"generateArtifact"</span>

    <span class="comment"># 有工件 → LLM 判断重写还是回复</span>
    <span class="comment"># 可能返回: "rewriteArtifact" 或 "replyToGeneralInput"</span>
    route = <span class="keyword">await</span> model_with_tool.ainvoke([...])
    <span class="keyword">return</span> route</code></pre>
            </section>

            <!-- Nodes Detail -->
            <section id="nodes">
                <h2>节点详情</h2>

                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <h3>工件操作节点</h3>
                        <span class="collapse-icon">▼</span>
                    </div>
                    <div class="card-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>节点</th>
                                    <th>功能</th>
                                    <th>文件</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>generateArtifact</code></td>
                                    <td>创建新工件 (代码或文本)</td>
                                    <td><code>nodes/generate_artifact.py</code></td>
                                </tr>
                                <tr>
                                    <td><code>rewriteArtifact</code></td>
                                    <td>完全重写现有工件</td>
                                    <td><code>nodes/rewrite_artifact.py</code></td>
                                </tr>
                                <tr>
                                    <td><code>updateArtifact</code></td>
                                    <td>修改代码高亮区域</td>
                                    <td><code>nodes/update_artifact.py</code></td>
                                </tr>
                                <tr>
                                    <td><code>updateHighlightedText</code></td>
                                    <td>修改文本高亮区域</td>
                                    <td><code>nodes/update_highlighted_text.py</code></td>
                                </tr>
                                <tr>
                                    <td><code>rewriteArtifactTheme</code></td>
                                    <td>文本主题变换 (语言/长度/风格)</td>
                                    <td><code>nodes/rewrite_artifact_theme.py</code></td>
                                </tr>
                                <tr>
                                    <td><code>rewriteCodeArtifactTheme</code></td>
                                    <td>代码主题变换 (注释/日志/移植)</td>
                                    <td><code>nodes/rewrite_code_artifact_theme.py</code></td>
                                </tr>
                                <tr>
                                    <td><code>customAction</code></td>
                                    <td>用户自定义快捷操作</td>
                                    <td><code>nodes/custom_action.py</code></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <h3>对话节点</h3>
                        <span class="collapse-icon">▼</span>
                    </div>
                    <div class="card-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>节点</th>
                                    <th>功能</th>
                                    <th>文件</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>replyToGeneralInput</code></td>
                                    <td>纯对话回复 (不涉及工件)</td>
                                    <td><code>nodes/reply_to_general_input.py</code></td>
                                </tr>
                                <tr>
                                    <td><code>generateFollowup</code></td>
                                    <td>工件操作后的跟进消息</td>
                                    <td><code>nodes/generate_followup.py</code></td>
                                </tr>
                                <tr>
                                    <td><code>reflect</code></td>
                                    <td>触发反思图，更新用户记忆</td>
                                    <td><code>nodes/reflect.py</code></td>
                                </tr>
                                <tr>
                                    <td><code>generateTitle</code></td>
                                    <td>生成对话标题</td>
                                    <td><code>nodes/generate_title.py</code></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" onclick="toggleCard(this)">
                        <h3>控制节点</h3>
                        <span class="collapse-icon">▼</span>
                    </div>
                    <div class="card-content">
                        <table>
                            <thead>
                                <tr>
                                    <th>节点</th>
                                    <th>功能</th>
                                    <th>实现位置</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>generatePath</code></td>
                                    <td>路由决策 (硬编码 + LLM)</td>
                                    <td><code>nodes/generate_path.py</code></td>
                                </tr>
                                <tr>
                                    <td><code>cleanState</code></td>
                                    <td>重置临时状态字段</td>
                                    <td><code>graph.py</code> (内联)</td>
                                </tr>
                                <tr>
                                    <td><code>webSearch</code></td>
                                    <td>Web 搜索占位 (TODO)</td>
                                    <td><code>graph.py</code> (内联)</td>
                                </tr>
                                <tr>
                                    <td><code>routePostWebSearch</code></td>
                                    <td>搜索后动态路由</td>
                                    <td><code>graph.py</code> (内联)</td>
                                </tr>
                                <tr>
                                    <td><code>summarizer</code></td>
                                    <td>摘要占位 (TODO)</td>
                                    <td><code>graph.py</code> (内联)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- State Structure -->
            <section id="state">
                <h2>状态结构</h2>
                <p>主图状态 <code>OpenCanvasState</code> 定义在 <code>state.py</code>，所有字段使用 camelCase 与前端保持一致。</p>

                <h3>核心字段</h3>
                <div class="state-field">
                    <span class="state-field-name">messages</span>
                    <span class="state-field-type">Annotated[list[AnyMessage], add_messages]</span>
                    <span class="state-field-desc">用户可见的消息列表</span>
                </div>
                <div class="state-field">
                    <span class="state-field-name">_messages</span>
                    <span class="state-field-type">Annotated[list[AnyMessage], _messages_reducer]</span>
                    <span class="state-field-desc">内部消息 (含摘要处理逻辑)</span>
                </div>
                <div class="state-field">
                    <span class="state-field-name">artifact</span>
                    <span class="state-field-type">Optional[ArtifactV3]</span>
                    <span class="state-field-desc">当前工件 (支持版本控制)</span>
                </div>
                <div class="state-field">
                    <span class="state-field-name">next</span>
                    <span class="state-field-type">Optional[str]</span>
                    <span class="state-field-desc">路由目标节点名称</span>
                </div>

                <h3>高亮字段</h3>
                <div class="state-field">
                    <span class="state-field-name">highlightedCode</span>
                    <span class="state-field-type">Optional[CodeHighlight]</span>
                    <span class="state-field-desc">代码高亮区域 {startCharIndex, endCharIndex}</span>
                </div>
                <div class="state-field">
                    <span class="state-field-name">highlightedText</span>
                    <span class="state-field-type">Optional[TextHighlight]</span>
                    <span class="state-field-desc">文本高亮区域 {fullMarkdown, markdownBlock, selectedText}</span>
                </div>

                <h3>快捷操作字段</h3>
                <div class="state-field">
                    <span class="state-field-name">language</span>
                    <span class="state-field-type">Optional[LanguageOptions]</span>
                    <span class="state-field-desc">翻译目标语言</span>
                </div>
                <div class="state-field">
                    <span class="state-field-name">artifactLength</span>
                    <span class="state-field-type">Optional[ArtifactLengthOptions]</span>
                    <span class="state-field-desc">工件长度选项</span>
                </div>
                <div class="state-field">
                    <span class="state-field-name">addComments / addLogs / fixBugs</span>
                    <span class="state-field-type">Optional[bool]</span>
                    <span class="state-field-desc">代码快捷操作标志</span>
                </div>
                <div class="state-field">
                    <span class="state-field-name">customQuickActionId</span>
                    <span class="state-field-type">Optional[str]</span>
                    <span class="state-field-desc">自定义快捷操作 ID</span>
                </div>

                <h3>_messages_reducer 特殊逻辑</h3>
                <pre><code><span class="keyword">def</span> <span class="function">_messages_reducer</span>(left, right):
    <span class="string">"""遇到摘要消息时清空历史，防止上下文爆炸"""</span>
    <span class="keyword">if</span> _is_summary_message(right[-<span class="number">1</span>]):
        <span class="keyword">return</span> add_messages([], right)  <span class="comment"># 清空历史</span>
    <span class="keyword">return</span> add_messages(left, right)  <span class="comment"># 正常追加</span></code></pre>
            </section>

            <!-- Types -->
            <section id="types">
                <h2>类型定义</h2>
                <p>核心类型定义在 <code>types.py</code>：</p>

                <h3>ArtifactV3</h3>
                <pre><code><span class="keyword">class</span> <span class="type">ArtifactV3</span>(TypedDict):
    currentIndex: <span class="type">int</span>                                    <span class="comment"># 当前版本索引</span>
    contents: <span class="type">list</span>[Union[ArtifactMarkdownV3, ArtifactCodeV3]]  <span class="comment"># 版本历史</span>

<span class="keyword">class</span> <span class="type">ArtifactCodeV3</span>(TypedDict):
    index: <span class="type">int</span>
    type: Literal[<span class="string">"code"</span>]
    title: <span class="type">str</span>
    language: <span class="type">ProgrammingLanguageOptions</span>
    code: <span class="type">str</span>
    isValidReact: Optional[<span class="type">bool</span>]  <span class="comment"># 是否可预览</span>

<span class="keyword">class</span> <span class="type">ArtifactMarkdownV3</span>(TypedDict):
    index: <span class="type">int</span>
    type: Literal[<span class="string">"text"</span>]
    title: <span class="type">str</span>
    fullMarkdown: <span class="type">str</span></code></pre>

                <h3>Reflections</h3>
                <pre><code><span class="keyword">class</span> <span class="type">Reflections</span>(TypedDict):
    styleRules: <span class="type">list</span>[<span class="type">str</span>]  <span class="comment"># 写作风格规则</span>
    content: <span class="type">list</span>[<span class="type">str</span>]      <span class="comment"># 用户事实/偏好</span></code></pre>
            </section>

            <!-- Auxiliary Graphs -->
            <section id="reflection">
                <h2>辅助图: reflection</h2>
                <p>分析对话内容，提取用户风格规则和信息，存储到 Store。</p>

                <div class="diagram-container">
                    <div class="diagram-title">reflection 图结构</div>
                    <svg width="400" height="120" viewBox="0 0 400 120">
                        <circle cx="50" cy="60" r="20" fill="#81c784"/>
                        <text x="50" y="65" class="node-text" font-size="11">START</text>

                        <rect x="130" y="40" width="120" height="40" rx="6" fill="#ba68c8"/>
                        <text x="190" y="65" class="node-text">reflect</text>

                        <circle cx="340" cy="60" r="20" fill="#e57373"/>
                        <text x="340" y="65" class="node-text" font-size="11">END</text>

                        <path d="M 70 60 L 130 60" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 250 60 L 320 60" class="edge" marker-end="url(#arrow)"/>
                    </svg>
                </div>

                <h4>功能</h4>
                <ul style="color: var(--text-secondary); margin-left: 20px;">
                    <li>使用 Claude 3.5 Sonnet 分析对话和工件</li>
                    <li>提取风格规则 (styleRules) 和用户信息 (content)</li>
                    <li>存储到 BaseStore: <code>("memories", assistant_id) / "reflection"</code></li>
                </ul>
            </section>

            <section id="thread-title">
                <h2>辅助图: thread_title</h2>
                <p>基于对话内容生成简洁的线程标题。</p>

                <div class="diagram-container">
                    <div class="diagram-title">thread_title 图结构</div>
                    <svg width="400" height="120" viewBox="0 0 400 120">
                        <circle cx="50" cy="60" r="20" fill="#81c784"/>
                        <text x="50" y="65" class="node-text" font-size="11">START</text>

                        <rect x="120" y="40" width="140" height="40" rx="6" fill="#81c784"/>
                        <text x="190" y="65" class="node-text">generateTitle</text>

                        <circle cx="340" cy="60" r="20" fill="#e57373"/>
                        <text x="340" y="65" class="node-text" font-size="11">END</text>

                        <path d="M 70 60 L 120 60" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 260 60 L 320 60" class="edge" marker-end="url(#arrow)"/>
                    </svg>
                </div>

                <h4>功能</h4>
                <ul style="color: var(--text-secondary); margin-left: 20px;">
                    <li>使用 GPT-4o-mini 生成标题</li>
                    <li>通过 LangGraph SDK Client 更新线程元数据</li>
                    <li>在首次对话 (messages <= 2) 时触发</li>
                </ul>
            </section>

            <section id="summarizer">
                <h2>辅助图: summarizer</h2>
                <p>压缩长对话历史，防止上下文无限增长。</p>

                <div class="diagram-container">
                    <div class="diagram-title">summarizer 图结构</div>
                    <svg width="400" height="120" viewBox="0 0 400 120">
                        <circle cx="50" cy="60" r="20" fill="#81c784"/>
                        <text x="50" y="65" class="node-text" font-size="11">START</text>

                        <rect x="130" y="40" width="120" height="40" rx="6" fill="#ba68c8"/>
                        <text x="190" y="65" class="node-text">summarize</text>

                        <circle cx="340" cy="60" r="20" fill="#e57373"/>
                        <text x="340" y="65" class="node-text" font-size="11">END</text>

                        <path d="M 70 60 L 130 60" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 250 60 L 320 60" class="edge" marker-end="url(#arrow)"/>
                    </svg>
                </div>

                <h4>功能</h4>
                <ul style="color: var(--text-secondary); margin-left: 20px;">
                    <li>使用 Claude 3.5 Sonnet 生成摘要</li>
                    <li>创建带 <code>OC_SUMMARIZED_MESSAGE_KEY</code> 标记的消息</li>
                    <li>通过 SDK Client 更新线程 _messages 状态</li>
                    <li>触发条件: 字符数 > 300,000 (CHARACTER_MAX)</li>
                </ul>
            </section>

            <section id="web-search">
                <h2>辅助图: web_search</h2>
                <p>基于 Exa 的网络搜索，包含 3 个节点的条件流程。</p>

                <div class="diagram-container">
                    <div class="diagram-title">web_search 图结构</div>
                    <svg width="600" height="200" viewBox="0 0 600 200">
                        <circle cx="50" cy="100" r="20" fill="#81c784"/>
                        <text x="50" y="105" class="node-text" font-size="11">START</text>

                        <rect x="110" y="80" width="140" height="40" rx="6" fill="#ba68c8"/>
                        <text x="180" y="105" class="node-text">classifyMessage</text>

                        <rect x="300" y="40" width="140" height="40" rx="6" fill="#ba68c8"/>
                        <text x="370" y="65" class="node-text">queryGenerator</text>

                        <rect x="300" y="120" width="100" height="40" rx="6" fill="#81c784"/>
                        <text x="350" y="145" class="node-text">search</text>

                        <circle cx="550" cy="100" r="20" fill="#e57373"/>
                        <text x="550" y="105" class="node-text" font-size="11">END</text>

                        <path d="M 70 100 L 110 100" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 250 90 L 280 90 L 280 60 L 300 60" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 250 110 L 280 110 L 280 140 L 530 140 L 530 110" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 440 60 L 470 60 L 470 140 L 400 140" class="edge" marker-end="url(#arrow)"/>
                        <path d="M 350 160 L 350 180 L 550 180 L 550 120" class="edge" marker-end="url(#arrow)"/>

                        <text x="260" y="80" class="edge-label" fill="#9d9d9d">shouldSearch</text>
                        <text x="260" y="130" class="edge-label" fill="#9d9d9d">否</text>
                    </svg>
                </div>

                <h4>节点说明</h4>
                <table>
                    <thead>
                        <tr>
                            <th>节点</th>
                            <th>功能</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>classifyMessage</code></td>
                            <td>判断消息是否需要搜索，设置 shouldSearch 标志</td>
                        </tr>
                        <tr>
                            <td><code>queryGenerator</code></td>
                            <td>生成优化的搜索查询</td>
                        </tr>
                        <tr>
                            <td><code>search</code></td>
                            <td>执行 Exa API 搜索，返回 SearchResult 列表</td>
                        </tr>
                    </tbody>
                </table>
            </section>

            <!-- Data Flow -->
            <section id="data-flow">
                <h2>请求处理流程</h2>
                <p>完整的用户请求处理时序：</p>

                <div class="diagram-container">
                    <div class="diagram-title">请求处理时序图</div>
                    <pre style="background: transparent; border: none; color: var(--text-secondary); font-size: 12px; line-height: 1.8;">
用户输入 "创建一个 React 计数器"
         │
         ▼
┌─────────────────────────────────────┐
│  前端: GraphContext                  │
│  → 创建 HumanMessage                │
│  → 调用 streamMessage(GraphInput)   │
└─────────────────────────────────────┘
         │ SSE Stream
         ▼
┌─────────────────────────────────────┐
│  后端: generatePath                  │
│  → 检查硬编码条件 (无匹配)           │
│  → LLM 动态路由 → "generateArtifact" │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  后端: generateArtifact              │
│  → 绑定 artifact 工具               │
│  → 获取 reflections (风格规则)       │
│  → 调用 LLM 生成代码                 │
│  → 返回 ArtifactV3                  │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  后端: generateFollowup              │
│  → 生成后续响应消息                  │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  后端: reflect                       │
│  → 触发 reflection 子图             │
│  → 更新用户记忆到 Store             │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  后端: cleanState                    │
│  → 重置临时状态字段                  │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  条件: messages <= 2 ?               │
│  → 是: generateTitle → END          │
│  → 否: 检查 chars > 300K            │
│      → 是: summarizer → END         │
│      → 否: END                       │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  前端: 处理 streaming chunks         │
│  → 累积 JSON 解析 artifact          │
│  → setArtifact(result)              │
│  → CodeRenderer + CodePreviewer     │
└─────────────────────────────────────┘
                    </pre>
                </div>
            </section>

            <!-- File Mapping -->
            <section id="files">
                <h2>文件映射</h2>

                <table>
                    <thead>
                        <tr>
                            <th>文件</th>
                            <th>用途</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><code>langgraph.json</code></td>
                            <td>图配置 (入口点、依赖、CORS)</td>
                        </tr>
                        <tr>
                            <td><code>src/open_canvas/graph.py</code></td>
                            <td>主图定义 (17 节点 + 边)</td>
                        </tr>
                        <tr>
                            <td><code>src/open_canvas/state.py</code></td>
                            <td>OpenCanvasState 状态定义</td>
                        </tr>
                        <tr>
                            <td><code>src/open_canvas/nodes/</code></td>
                            <td>所有节点函数实现</td>
                        </tr>
                        <tr>
                            <td><code>src/open_canvas/prompts.py</code></td>
                            <td>Prompt 模板</td>
                        </tr>
                        <tr>
                            <td><code>src/reflection/graph.py</code></td>
                            <td>反思图定义</td>
                        </tr>
                        <tr>
                            <td><code>src/thread_title/graph.py</code></td>
                            <td>标题生成图定义</td>
                        </tr>
                        <tr>
                            <td><code>src/summarizer/graph.py</code></td>
                            <td>摘要图定义</td>
                        </tr>
                        <tr>
                            <td><code>src/web_search/graph.py</code></td>
                            <td>搜索图定义</td>
                        </tr>
                        <tr>
                            <td><code>src/types.py</code></td>
                            <td>共享类型定义</td>
                        </tr>
                        <tr>
                            <td><code>src/constants.py</code></td>
                            <td>常量定义</td>
                        </tr>
                        <tr>
                            <td><code>src/utils.py</code></td>
                            <td>工具函数</td>
                        </tr>
                    </tbody>
                </table>
            </section>
        </main>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip">
        <div class="tooltip-title"></div>
        <div class="tooltip-content"></div>
    </div>

    <script>
        // Theme Toggle
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;

        // Check for saved theme preference or system preference
        const savedTheme = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

        if (savedTheme) {
            html.setAttribute('data-theme', savedTheme);
        } else if (!systemPrefersDark) {
            html.setAttribute('data-theme', 'light');
        }

        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });

        // Node descriptions
        const nodeDescriptions = {
            'generatePath': {
                title: 'generatePath',
                content: '路由决策节点。根据状态字段决定下一个处理节点，采用硬编码优先 + LLM 动态路由策略。'
            },
            'generateArtifact': {
                title: 'generateArtifact',
                content: '创建新工件。使用 LLM 生成代码或文本，返回 ArtifactV3 结构。'
            },
            'rewriteArtifact': {
                title: 'rewriteArtifact',
                content: '完全重写现有工件。保留版本历史，创建新版本。'
            },
            'updateArtifact': {
                title: 'updateArtifact',
                content: '修改代码高亮区域。只更新 highlightedCode 指定的部分。'
            },
            'updateHighlightedText': {
                title: 'updateHighlightedText',
                content: '修改文本高亮区域。处理 Markdown 文档的局部编辑。'
            },
            'rewriteArtifactTheme': {
                title: 'rewriteArtifactTheme',
                content: '文本主题变换。支持语言翻译、长度调整、阅读级别等。'
            },
            'rewriteCodeArtifactTheme': {
                title: 'rewriteCodeArtifactTheme',
                content: '代码主题变换。支持添加注释、日志、移植语言、修复 Bug 等。'
            },
            'customAction': {
                title: 'customAction',
                content: '用户自定义快捷操作。从 Store 读取操作定义并执行。'
            },
            'replyToGeneralInput': {
                title: 'replyToGeneralInput',
                content: '纯对话回复。不涉及工件操作，直接返回消息。'
            },
            'generateFollowup': {
                title: 'generateFollowup',
                content: '工件操作后的跟进消息。生成友好的响应告知用户操作结果。'
            },
            'reflect': {
                title: 'reflect',
                content: '触发反思图，更新用户记忆。提取风格规则和用户信息到 Store。'
            },
            'generateTitle': {
                title: 'generateTitle',
                content: '生成对话标题。在首次对话时触发，更新线程元数据。'
            },
            'cleanState': {
                title: 'cleanState',
                content: '重置临时状态字段。防止状态污染下一轮路由。'
            },
            'webSearch': {
                title: 'webSearch',
                content: 'Web 搜索节点。当前为占位实现，将在后续版本集成 web_search 子图。'
            },
            'routePostWebSearch': {
                title: 'routePostWebSearch',
                content: '搜索后路由。根据搜索结果决定路由到 generateArtifact 或 rewriteArtifact。'
            },
            'summarizer': {
                title: 'summarizer',
                content: '摘要节点。当字符数超过 300K 时触发，压缩对话历史。'
            }
        };

        // Tooltip handling
        const tooltip = document.getElementById('tooltip');
        const nodes = document.querySelectorAll('.node');

        nodes.forEach(node => {
            node.addEventListener('mouseenter', (e) => {
                const nodeName = node.dataset.node;
                const desc = nodeDescriptions[nodeName];
                if (desc) {
                    tooltip.querySelector('.tooltip-title').textContent = desc.title;
                    tooltip.querySelector('.tooltip-content').textContent = desc.content;
                    tooltip.classList.add('visible');
                }
            });

            node.addEventListener('mousemove', (e) => {
                tooltip.style.left = (e.clientX + 15) + 'px';
                tooltip.style.top = (e.clientY + 15) + 'px';
            });

            node.addEventListener('mouseleave', () => {
                tooltip.classList.remove('visible');
            });
        });

        // Card collapse
        function toggleCard(header) {
            const card = header.parentElement;
            card.classList.toggle('collapsed');
        }

        // Smooth scroll for nav links
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').slice(1);
                const target = document.getElementById(targetId);
                if (target) {
                    target.scrollIntoView({ behavior: 'smooth' });
                }

                // Update active state
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
            });
        });

        // Update active nav on scroll
        window.addEventListener('scroll', () => {
            const sections = document.querySelectorAll('section');
            let current = '';

            sections.forEach(section => {
                const sectionTop = section.offsetTop;
                if (scrollY >= sectionTop - 100) {
                    current = section.getAttribute('id');
                }
            });

            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === '#' + current) {
                    link.classList.add('active');
                }
            });
        });
    </script>
</body>
</html>